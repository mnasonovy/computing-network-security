# Лабораторная работа №6  
**Тема:** Установка и настройка UserGate NGFW

---

## Цель работы

1. Выполнить установку и первоначальную настройку межсетевого экрана UserGate NGFW в среде виртуализации VMWare Workstation.
2. Настроить сетевые адаптеры для обеспечения доступа к интернету и управления системой.
3. Подключить клиентскую машину под управлением Windows 10/11 к UserGate NGFW.
4. Настроить правила межсетевого экрана и NAT для обеспечения доступа клиента в интернет.
5. Реализовать управление пропускной способностью и фильтрацию трафика.
6. Настроить фильтрацию контента с использованием инспектирования SSL (задание на автомат).
7. Закрепить навыки работы с межсетевыми экранами нового поколения и понимание концепции зон безопасности.

---

## Задание

### Основная часть:

1. Установить UserGate NGFW в VMWare Workstation.
2. Настроить два сетевых адаптера для UserGate:
   - **Network Adapter 1**: Internal Network (зона Management) — для управления и подключения клиента.
   - **Network Adapter 2**: Bridge (зона Trusted) — для доступа в интернет.
3. Настроить клиентскую машину Windows 10/11:
   - Использовать только Internal Network адаптер.
   - Получать все сетевые настройки от UserGate NGFW.
4. Выполнить первоначальную настройку UserGate через веб-интерфейс:
   - Настроить IP-адреса интерфейсов.
   - Настроить DNS и шлюз по умолчанию.
5. Создать правила NAT и межсетевого экрана:
   - Базовое правило NAT для выхода клиента в интернет.
   - Разрешающее правило межсетевого экрана (разместить наверху).
   - Запрещающее правило по умолчанию (разместить внизу).
6. Проверить доступ клиента в интернет.
7. Выполнить замер скорости интернета на клиенте.
8. Настроить ограничение пропускной способности с помощью UserGate.
9. Выполнить повторный замер скорости и сравнить результаты.
10. Создать правила для:
    - Разрешения HTTP/HTTPS подключений.
    - Запрета ICMP-запросов (ping).
11. Продемонстрировать работу настроенных правил.

### Задание на автомат:

1. Настроить инспектирование SSL на UserGate NGFW.
2. Экспортировать сертификат удостоверяющего центра (CA.der).
3. Импортировать сертификат в хранилище доверенных корневых центров сертификации на клиентской машине.
4. Настроить правило фильтрации контента для блокировки поисковика Яндекс.
5. Продемонстрировать результат работы фильтрации.
6. Быть готовым ответить на вопросы о зонах безопасности, протоколах и механизмах работы UserGate NGFW.

---

## Описание стенда

- **Хостовая система**: Windows + VMWare Workstation
- **UserGate NGFW**: 
  - ОС: UGOS NGFW 7.4.0 или выше
  - Ресурсы: 4 vCPU, 8 GB RAM
  - Жесткий диск 1: 20 GB (система)
  - Сетевые адаптеры:
    - **port0**: Bridge
    - **port1**: Custom
  - Учетные данные по умолчанию: `Admin` / `usergate`
  
- **Клиентская машина**: Windows 10/11
  - Ресурсы: 4 vCPU, 8 GB RAM
  - Сетевой адаптер: Custom (та же сеть, что и port0 UserGate)

---

## Ход выполнения работы

### 1. Подготовка среды виртуализации

#### 1.1. Настройка виртуальных сетей в VMWare Workstation

Перед созданием виртуальных машин необходимо настроить сетевые адаптеры в VMWare.

Открываем **Virtual Network Editor** (Edit → Virtual Network Editor).


Настраиваем Internal Network:
1. Нажимаем **Change Settings** (требуются права администратора).
2. Выбираем существующую внутреннюю сеть (например, VMnet1) или создаем новую (Add Network).
3. Устанавливаем тип: **Host-only** или **Custom** для internal сети.
4. Задаем параметры подсети:
   - Subnet IP: например, `192.168.237.0`
   - Subnet mask: `255.255.255.0`
5. Убеждаемся, что включен **Use local DHCP service** (опционально, можно отключить, так как DHCP будет на UserGate).


Настраиваем Bridge адаптер:
1. В Virtual Network Editor выбираем VMnet0 (Bridged).
2. Нажимаем **Bridged to** и выбираем физический сетевой адаптер, имеющий доступ в интернет.
3. Применяем настройки.


---

### 2. Установка UserGate NGFW

#### 2.1. Создание виртуальной машины для UserGate

1. Создаем новую виртуальную машину в VMWare Workstation.
2. Выбираем образ UserGate NGFW (файл .iso или .ova).
3. Задаем параметры:
   - **Память**: 8 GB
   - **Процессоры**: 4 ядра
   - **Жесткий диск 1**: 20 GB (Thin provisioned)
   - **Жесткий диск 2**: 100 GB (Thin provisioned)


#### 2.2. Настройка сетевых адаптеров UserGate

Открываем настройки виртуальной машины (VM Settings → Hardware).

Добавляем/настраиваем сетевые адаптеры:

**Network Adapter 1** (port0 - Management):
- Network connection: **Custom** → выбираем внутреннюю сеть (например, VMnet1 или ug-lan2)
- Отмечаем **Connect at power on**

**Network Adapter 2** (port1 - Internet):
- Network connection: **Bridged** → выбираем физический адаптер с доступом в интернет
- Отмечаем **Connect at power on**


#### 2.3. Первый запуск UserGate NGFW

Запускаем виртуальную машину UserGate.

После загрузки системы на экране появится консоль с информацией о системе:

```
UGOS NGFW 7.4.0.209490R
Web-administrator GUI: https://127.0.0.1:8001/
UGOS login:
```

Проблема: веб-интерфейс доступен только по адресу loopback (127.0.0.1), что не позволяет подключиться с клиентской машины. Необходимо назначить статический IP-адрес интерфейсу port0.

---

### 3. Настройка сетевых интерфейсов UserGate через консоль

#### 3.1. Назначение IP-адреса интерфейсу port0

Входим в систему через консоль:
- Логин: `Admin`
- Пароль: `usergate`

Выполняем команды для настройки IP-адреса на интерфейсе port0:

```bash
configure
    network interface port0
        ip address 172.16.10.2/26
    exit
    commit
    exit
```

**Примечание:** IP-адрес и маска подсети должны соответствовать настройкам вашей internal сети в VMWare. В данном примере используется подсеть `172.16.10.0/26`.

ыполнение команд настройки IP-адреса в консоли]****[СКРИНШОТ 8: В

#### 3.2. Перезагрузка системы

Выполняем перезагрузку для применения изменений:

```bash
reboot
```

После перезагрузки на экране консоли должна отобразиться информация с новым IP-адресом:

```
UGOS NGFW 7.4.0.209490R
Web-administrator GUI: https://172.16.10.2:8001/
UGOS login:
```

---

### 4. Настройка клиентской машины Windows

#### 4.1. Настройка сетевого адаптера

Переходим к виртуальной машине Windows 10/11.

В настройках виртуальной машины:
- **Network Adapter**: Custom → выбираем ту же internal сеть, что и для port0 UserGate (например, VMnet1 или ug-lan2)
- Отмечаем **Connect at power on**


#### 4.2. Настройка статического IP-адреса

На клиентской машине Windows открываем:
**Панель управления** → **Сеть и Интернет** → **Центр управления сетями и общим доступом** → **Изменение параметров адаптера**

Открываем свойства сетевого адаптера **Ethernet0** (или соответствующего).


Выбираем **Протокол Интернета версии 4 (TCP/IPv4)** → **Свойства**.

Устанавливаем следующие параметры:

- **IP-адрес**: `172.16.10.11` (или другой адрес из той же подсети, но не 172.16.10.2)
- **Маска подсети**: `255.255.255.192`
- **Основной шлюз**: `172.16.10.2` (IP-адрес UserGate)
- **Предпочитаемый DNS-сервер**: `172.16.10.2`
- **Альтернативный DNS-сервер**: `8.8.8.8`


Нажимаем **OK** для сохранения настроек.

#### 4.3. Проверка связности с UserGate

Открываем **Командную строку** (Win + R → `cmd`).

Выполняем команду ping для проверки доступности UserGate:

```cmd
ping 172.16.10.2
```

Ожидаемый результат: пакеты успешно отправляются и получаются.

```
Обмен пакетами с 172.16.10.2 по с 32 байтами данных:
Ответ от 172.16.10.2: число байт=32 время=1мс TTL=64
Ответ от 172.16.10.2: число байт=32 время<1мс TTL=64
Ответ от 172.16.10.2: число байт=32 время<1мс TTL=64
Ответ от 172.16.10.2: число байт=32 время<1мс TTL=64

Статистика Ping для 172.16.10.2:
    Пакетов: отправлено = 4, получено = 4, потеряно = 0
    (0% потерь)
Приблизительное время приема-передачи в мс:
    Минимальное = 0мсек, Максимальное = 1мсек, Среднее = 0мсек
```

---

### 5. Первоначальная настройка UserGate через веб-интерфейс

#### 5.1. Доступ к веб-консоли администратора

На клиентской машине Windows открываем браузер и переходим по адресу:

```
https://172.16.10.2:8001
```

**Примечание:** Браузер может выдать предупреждение о недоверенном сертификате — это нормально, так как используется самоподписанный сертификат. Добавляем исключение и продолжаем.

Откроется окно первоначальной настройки UserGate NGFW.


#### 5.2. Прохождение мастера начальной настройки

**Шаг 1: Выбор языка интерфейса**

Выбираем **Русский** и нажимаем **Далее >**.

**Шаг 2: Выбор варианта использования узла**

Выбираем **Автономный узел или первый узел кластера** и нажимаем **Далее >**.


**Шаг 3: Установка пароля администратора**

Вводим новый пароль для учетной записи `Admin` и подтверждаем его. Нажимаем **Далее >**.


**Шаг 4: Завершение начальной настройки**

Мастер первоначальной настройки завершен. Нажимаем **Войти в систему** или **Завершить**.

После входа в систему откроется главная панель управления (Dashboard) UserGate NGFW.

---

### 6. Настройка сетевых параметров UserGate

#### 6.1. Определение параметров шлюза и DNS

Для того чтобы UserGate имел доступ в интернет, необходимо узнать параметры шлюза и DNS основной (хостовой) машины.

На хостовой машине Windows открываем командную строку и выполняем:

```cmd
ipconfig /all
```

Находим адаптер, который имеет доступ в интернет (обычно это адаптер беспроводной или проводной сети). Записываем:
- **IP-адрес**: например, `10.63.2.101`
- **Маска подсети**: `255.255.255.128`
- **Основной шлюз**: например, `10.63.2.1`
- **DNS-серверы**: например, `8.8.8.8`, `1.1.1.1`


#### 6.2. Настройка интерфейса port1 (выход в интернет)

В веб-консоли UserGate переходим:
**Настройки** → **Сеть** → **Интерфейсы**

Находим интерфейс **port1** и нажимаем на него для редактирования.


На вкладке **Общие** настраиваем:
- **Зона**: выбираем **Trusted**
- **Режим**: **Статический IP**
- **IP-адрес**: указываем адрес из той же подсети, что и хостовая машина (например, `10.63.2.231/25` или `192.168.1.231/24` в зависимости от вашей сети)


Нажимаем **Сохранить**.

#### 6.3. Настройка шлюза по умолчанию

Переходим: **Настройки** → **Сеть** → **Шлюзы**

Нажимаем **Добавить** для создания нового шлюза.

Заполняем параметры:
- **Название**: `gate` (или любое другое)
- **IP шлюза**: указываем IP-адрес основного шлюза (например, `10.63.2.1` или `192.168.1.1`)
- **Интерфейс**: выбираем **port1**
- **MAC**: можно оставить пустым
- **Протокол**: Static
- Отмечаем **По умолчанию**

Нажимаем **Сохранить**.


#### 6.4. Настройка DNS-серверов

Переходим: **Настройки** → **Сеть** → **DNS**

В разделе **Системные DNS-серверы** нажимаем **Добавить**.

Добавляем адреса DNS-серверов:
- `8.8.8.8` (Google DNS)
- `1.1.1.1` (Cloudflare DNS)


В разделе **Настройки DNS-прокси** проверяем, что включено:
- **DNS-фильтрация**: Отключено (можно включить при необходимости)
- **Кэширование DNS**: Включено
- **Рекурсивные DNS-запросы**: Включено


Нажимаем **Сохранить** (если есть кнопка редактирования).

#### 6.5. Проверка доступности интернета для UserGate

Переходим: **Диагностика и мониторинг** → **Ping**

Заполняем параметры:
- **Ping host**: `8.8.8.8`
- **TTL**: `30`
- **Интерфейс**: выбираем **port1**
- **Счетчик**: `6`

Нажимаем **Старт**.


Проверяем результат выполнения ping. Ожидаемый результат:

```
PING 8.8.8.8 (8.8.8.8) from 192.168.1.231 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_req=1 ttl=108 time=37.6 ms
64 bytes from 8.8.8.8: icmp_req=2 ttl=108 time=39.1 ms
64 bytes from 8.8.8.8: icmp_req=3 ttl=108 time=34.5 ms
64 bytes from 8.8.8.8: icmp_req=4 ttl=108 time=40.9 ms
64 bytes from 8.8.8.8: icmp_req=5 ttl=108 time=47.8 ms
64 bytes from 8.8.8.8: icmp_req=6 ttl=108 time=38.6 ms

8.8.8.8 ping statistics
6 packets transmitted, 6 received, 0% packet loss, time 5006ms
rtt min/avg/max/mdev 34.552/39.790/47.828/4.081 ms
```


Если пинг проходит успешно, значит UserGate имеет доступ в интернет.

---

### 7. Настройка правил межсетевого экрана и NAT

На данном этапе клиентская машина не имеет доступа в интернет, так как не настроены правила межсетевого экрана и NAT. Необходимо создать соответствующие правила.

#### 7.1. Создание правила NAT

Переходим: **Политики сети** → **NAT и маршрутизация**

Нажимаем **Добавить** для создания нового правила NAT.


Заполняем параметры на вкладке **Общие**:
- **Название**: `NAT from Management to Internet`
- **Включить**: отмечено
- **Тип правила**: **NAT**
- **Действие**: Разрешить (по умолчанию для NAT)


Переходим на вкладку **Источник**:
- **Зона источника**: выбираем **Management**


Переходим на вкладку **Назначение**:
- **Зона назначения**: выбираем **Trusted**

Переходим на вкладку **NAT**:
- **SNAT IP (внешний адрес)**: можно оставить пустым (будет использоваться IP интерфейса port1 автоматически) или явно указать IP-адрес интерфейса port1 (например, `192.168.1.231`)

Нажимаем **Сохранить**.

Убеждаемся, что правило **включено** (должна быть зеленая галочка или индикатор).

#### 7.2. Создание разрешающего правила межсетевого экрана

Переходим: **Политики сети** → **Межсетевой экран**

По умолчанию в UserGate уже есть набор предустановленных правил. В конце списка находится правило **"Блокировать все"** (Default block), которое нельзя удалить или переместить.

Нам необходимо создать правило, которое будет разрешать весь трафик из зоны Management в зону Trusted, и разместить его **выше** правила "Блокировать все".

Нажимаем **Добавить** для создания нового правила.

Заполняем параметры на вкладке **Общие**:
- **Название**: `Allow Management to Trusted`
- **Включить**: отмечено
- **Действие**: **Разрешить**
- **Позиция**: выбираем **Перед правилом** → выбираем последнее разрешающее правило или "Блокировать все" (правило должно быть выше блокирующего)



Переходим на вкладку **Источник**:
- **Зона источника**: выбираем **Management**


Переходим на вкладку **Назначение**:
- **Зона назначения**: выбираем **Trusted**


Нажимаем **Сохранить**.

Убеждаемся, что правило **включено** и расположено **выше** правила "Блокировать все".


#### 7.3. Проверка доступа в интернет на клиентской машине

Возвращаемся к клиентской машине Windows.

Открываем командную строку и выполняем:

```cmd
ping 8.8.8.8
```

Ожидаемый результат: пакеты успешно отправляются и получаются.

```
Обмен пакетами с 8.8.8.8 по с 32 байтами данных:
Ответ от 8.8.8.8: число байт=32 время=45мс TTL=117
Ответ от 8.8.8.8: число байт=32 время=43мс TTL=117
Ответ от 8.8.8.8: число байт=32 время=41мс TTL=117
Ответ от 8.8.8.8: число байт=32 время=44мс TTL=117

Статистика Ping для 8.8.8.8:
    Пакетов: отправлено = 4, получено = 4, потеряно = 0
    (0% потерь)
```


Открываем браузер и проверяем доступ к веб-сайтам (например, https://www.google.com).

Если все работает корректно, клиент имеет полноценный доступ в интернет через UserGate NGFW.

---

### 8. Тестирование скорости интернет-соединения

#### 8.1. Замер скорости до ограничения

На клиентской машине открываем браузер и переходим на сайт для тестирования скорости интернета, например:
- https://www.speedtest.net/
- https://fast.com/

Запускаем тест скорости и записываем результаты:
- **Скорость загрузки (Download)**: например, 95 Мбит/с
- **Скорость выгрузки (Upload)**: например, 90 Мбит/с
- **Ping (Latency)**: например, 15 мс

#### 8.2. Настройка ограничения пропускной способности

Переходим в веб-консоли UserGate: **Политики сети** → **Пропускная способность**

Нажимаем **Добавить** для создания нового правила управления пропускной способностью.

Заполняем параметры на вкладке **Общие**:
- **Название**: `Limit bandwidth for Management zone`
- **Включить**: отмечено
- **Позиция**: Первое правило


Переходим на вкладку **Источник**:
- **Зона источника**: выбираем **Management**


Переходим на вкладку **Полоса пропускания**:
- Нажимаем **Добавить** для создания новой полосы пропускания (если не создана ранее).
- Задаем параметры:
  - **Название**: `10 Mbps limit`
  - **Гарантированная скорость**: `1024` Кбит/с (1 Мбит/с)
  - **Максимальная скорость**: `10240` Кбит/с (10 Мбит/с)
- Нажимаем **Сохранить**.

Выбираем созданную полосу пропускания.


Нажимаем **Сохранить** для сохранения правила.


#### 8.3. Повторный замер скорости после ограничения

Возвращаемся к клиентской машине и снова запускаем тест скорости на том же сайте.

Записываем новые результаты:
- **Скорость загрузки (Download)**: например, 9.8 Мбит/с (ограничена до ~10 Мбит/с)
- **Скорость выгрузки (Upload)**: например, 9.5 Мбит/с
- **Ping (Latency)**: может незначительно измениться


#### 8.4. Сравнение результатов

Сравниваем результаты двух тестов:

| Параметр | До ограничения | После ограничения |
|----------|----------------|-------------------|
| Download (Мбит/с) | 95 | 9.8 |
| Upload (Мбит/с) | 90 | 9.5 |
| Ping (мс) | 15 | 16 |

**Вывод:** Правило управления пропускной способностью работает корректно. Скорость интернет-соединения клиента была успешно ограничена до заданных значений (~10 Мбит/с).

---

### 9. Настройка правил фильтрации трафика по протоколам

#### 9.1. Создание правила для разрешения HTTP/HTTPS

Переходим: **Политики сети** → **Межсетевой экран**

Нажимаем **Добавить** для создания нового правила.

Заполняем параметры на вкладке **Общие**:
- **Название**: `Allow HTTP/HTTPS from Management`
- **Включить**: отмечено
- **Действие**: **Разрешить**
- **Позиция**: выбираем позицию выше общего разрешающего правила


Переходим на вкладку **Источник**:
- **Зона источника**: выбираем **Management**

Переходим на вкладку **Назначение**:
- **Зона назначения**: выбираем **Trusted**

Переходим на вкладку **Сервисы**:
- Нажимаем **Добавить** → **Добавить сервисы**
- Выбираем из списка:
  - **HTTP** (TCP порт 80)
  - **HTTPS** (TCP порт 443)
- Нажимаем **Добавить**, затем **Закрыть**


Нажимаем **Сохранить**.


#### 9.2. Создание правила для блокировки ICMP

Нажимаем **Добавить** для создания нового правила.

Заполняем параметры на вкладке **Общие**:
- **Название**: `Block ICMP from Management`
- **Включить**: отмечено
- **Действие**: **Запретить**
- **Позиция**: выбираем позицию **выше** общего разрешающего правила, но **ниже** правила HTTP/HTTPS (более специфичные правила размещаются выше)

Переходим на вкладку **Источник**:
- **Зона источника**: выбираем **Management**

Переходим на вкладку **Назначение**:
- **Зона назначения**: выбираем **Trusted** (или **Any** для блокировки всех ICMP)

Переходим на вкладку **Сервисы**:
- Нажимаем **Добавить** → **Добавить сервисы**
- Выбираем из списка:
  - **ICMP** (Any ICMP)
  - Или создаем сервис с протоколом ICMP
- Нажимаем **Добавить**, затем **Закрыть**

Нажимаем **Сохранить**.

**Важно:** Необходимо расположить правила в правильном порядке:
1. Правило "Block ICMP from Management" (запрет ICMP)
2. Правило "Allow HTTP/HTTPS from Management" (разрешение HTTP/HTTPS)
3. Правило "Allow Management to Trusted" (общее разрешение) — если оно все еще активно, его можно отключить или оставить как fallback
4. Правило "Блокировать все" (Default block) — всегда последнее

#### 9.3. Тестирование правил фильтрации

**Проверка блокировки ICMP:**

На клиентской машине открываем командную строку и выполняем:

```cmd
ping 8.8.8.8
```

Ожидаемый результат: пакеты **не доходят** до адресата, так как ICMP-трафик блокируется.

```
Превышен интервал ожидания для запроса.
Превышен интервал ожидания для запроса.
Превышен интервал ожидания для запроса.
Превышен интервал ожидания для запроса.

Статистика Ping для 8.8.8.8:
    Пакетов: отправлено = 4, получено = 0, потеряно = 4
    (100% потерь)
```

**Проверка разрешения HTTP/HTTPS:**

Открываем браузер и переходим на любой веб-сайт, например:
- http://example.com (HTTP)
- https://www.google.com (HTTPS)

Сайты должны открываться корректно.

**Вывод:** Правила межсетевого экрана работают корректно. HTTP/HTTPS трафик разрешен, ICMP-запросы блокируются.

---

### 10. Задание на автомат: настройка фильтрации контента с инспектированием SSL

#### 10.1. Включение инспектирования SSL

Переходим в веб-консоли UserGate: **Политики безопасности** → **Инспектирование SSL**

Нажимаем **Добавить** для создания нового правила инспектирования SSL.

Заполняем параметры на вкладке **Общие**:
- **Название**: `SSL Inspection for Management zone`
- **Включить**: отмечено
- **Действие**: **Дешифровать**

Переходим на вкладку **Источник**:
- **Зона источника**: выбираем **Management**

Переходим на вкладку **Назначение**:
- **Зона назначения**: можно оставить **Any** или выбрать **Trusted**

Нажимаем **Сохранить**.

Убеждаемся, что правило включено и активно.

#### 10.2. Экспорт сертификата CA для инспектирования SSL

Переходим: **Настройки** → **Управление устройством** → **Сертификаты**

Находим сертификат типа **SSL-инспектирование** (обычно называется "CA (Default)" или "SSL Inspection CA").


Выбираем сертификат и нажимаем кнопку **Экспортировать** (или **Скачать**).

Сохраняем файл сертификата (обычно с расширением `.crt`, `.pem` или `.der`). Если требуется формат `.der`, выбираем соответствующий формат при экспорте.

**Альтернативный способ:** Скачать сертификат напрямую по ссылке с клиентской машины:

```
http://172.16.10.2:8002/cps/ca
```

Открываем эту ссылку в браузере на клиентской машине. Файл сертификата начнет загружаться.


#### 10.3. Импорт сертификата CA на клиентской машине

На клиентской машине Windows:

1. Находим скачанный файл сертификата (например, `ca.crt` или `ca.der`).
2. Щелкаем правой кнопкой мыши по файлу и выбираем **Установить сертификат**.


3. В мастере импорта сертификатов:
   - **Расположение хранилища**: выбираем **Локальный компьютер** (требуются права администратора) или **Текущий пользователь**
   - Нажимаем **Далее**

4. Выбираем **Поместить все сертификаты в следующее хранилище**:
   - Нажимаем **Обзор...**
   - Выбираем **Доверенные корневые центры сертификации** (Trusted Root Certification Authorities)
   - Нажимаем **ОК**

5. Нажимаем **Далее**, затем **Готово**.

6. Появится предупреждение безопасности. Нажимаем **Да** для подтверждения установки сертификата.

7. Появится сообщение об успешном импорте.

#### 10.4. Проверка работы инспектирования SSL

Открываем браузер на клиентской машине и переходим на любой HTTPS-сайт, например https://www.google.com.

Открываем информацию о сертификате сайта (щелкнуть на замок в адресной строке → **Сертификат**).

Проверяем цепочку сертификатов: корневым центром сертификации должен быть сертификат UserGate, который мы установили.

Если сертификат выдан UserGate CA и браузер не показывает предупреждений, значит инспектирование SSL работает корректно.

#### 10.5. Настройка правила фильтрации контента для блокировки Яндекса

Переходим в веб-консоли UserGate: **Политики безопасности** → **Фильтрация контента**

Нажимаем **Добавить** для создания нового правила фильтрации контента.

Заполняем параметры на вкладке **Общие**:
- **Название**: `Block Yandex search`
- **Включить**: отмечено
- **Действие**: **Запретить**

Переходим на вкладку **Источник**:
- **Зона источника**: выбираем **Management**

Переходим на вкладку **URL-адреса**:
- Нажимаем **Добавить** → **Добавить URL-адрес**
- Вводим:
  - `yandex.ru`
  - `*.yandex.ru`
  - `yandex.com`
  - `*.yandex.com`
- Нажимаем **Добавить**, затем **Закрыть**

**Альтернативный метод через категории:**
- Переходим на вкладку **Категории**
- Если Яндекс находится в какой-либо категории (например, "Поисковые системы"), выбираем эту категорию
- Или создаем собственную категорию URL и добавляем туда адреса Яндекса

Нажимаем **Сохранить**.

Убеждаемся, что правило включено и расположено **выше** разрешающих правил фильтрации контента (если они есть).

#### 10.6. Тестирование блокировки Яндекса

На клиентской машине открываем браузер и пытаемся зайти на:
- https://yandex.ru
- https://www.yandex.ru

Ожидаемый результат: сайт **не открывается**, вместо него отображается **страница блокировки UserGate**.

Страница блокировки может выглядеть примерно так:

```
Доступ к ресурсу заблокирован

URL: https://yandex.ru
Причина: Нарушение политики фильтрации контента
Обратитесь к администратору сети
```

Пробуем открыть другие поисковые системы (например, Google, Bing) — они должны открываться нормально.


**Вывод:** Фильтрация контента с инспектированием SSL работает корректно. Доступ к поисковику Яндекс успешно заблокирован.

---

### 11. Проверка журналов и мониторинг

#### 11.1. Просмотр журнала межсетевого экрана

Переходим: **Журналы и отчеты** → **Журналы трафика** → **Межсетевой экран**

Здесь отображаются все события, связанные с работой межсетевого экрана: разрешенные и заблокированные соединения.


Проверяем наличие записей о заблокированных ICMP-запросах и разрешенных HTTP/HTTPS соединениях.

#### 11.2. Просмотр журнала фильтрации контента

Переходим: **Журналы и отчеты** → **Журналы трафика** → **Фильтрация контента**

Здесь отображаются все события, связанные с фильтрацией контента: заблокированные URL, категории, морфология.

Проверяем наличие записи о блокировке yandex.ru.

#### 11.3. Мониторинг текущих соединений

Переходим: **Диагностика и мониторинг** → **Мониторинг трафика**

Здесь отображаются все активные соединения в реальном времени.



Можно увидеть источник, назначение, протокол, объем переданных данных и другую информацию о соединениях.

---

## Контрольные вопросы и ответы

При сдаче лабораторной работы необходимо быть готовым ответить на следующие вопросы:

### 1. Что такое зона в UserGate?

**Ответ:**  
Зона в UserGate — это логическое объединение сетевых интерфейсов. Политики безопасности UserGate используют зоны интерфейсов, а не непосредственно сами интерфейсы. Это дает необходимую гибкость политикам безопасности и упрощает управление конфигурацией, особенно в условиях отказоустойчивых кластеров.

Рекомендуется объединять интерфейсы в зоны на основе их функционального назначения:
- Зона LAN-интерфейсов (обычно Trusted)
- Зона интернет-интерфейсов (обычно Untrusted)
- Зона управления (Management)
- Зоны для подключения к сетям партнеров (DMZ)

### 2. Какие зоны бывают в UserGate по умолчанию?

**Ответ:**  
По умолчанию UserGate NGFW поставляется со следующими предустановленными зонами:

- **Management** — зона для управления устройством
- **Trusted** — доверенная зона (обычно внутренняя сеть организации)
- **Untrusted** — недоверенная зона (обычно интернет)
- **DMZ** — демилитаризованная зона (для публичных серверов)
- **VPN for road warriors** — зона для удаленных VPN-подключений
- **VPN for Site-to-Site** — зона для межофисных VPN-соединений

Администраторы могут изменять настройки существующих зон и создавать новые (максимум 255 зон).

### 3. Можно ли запретить доступ в интернет по определенному протоколу? Как это сделать?

**Ответ:**  
Да, можно. Для этого необходимо создать запрещающее правило в разделе **Политики сети** → **Межсетевой экран**.

**Порядок действий:**
1. Создать новое правило с действием **Запретить**.
2. На вкладке **Источник** указать зону или адреса, для которых применяется правило.
3. На вкладке **Назначение** указать зону назначения (обычно Untrusted для интернета).
4. На вкладке **Сервисы** выбрать протокол, который необходимо заблокировать (например, FTP, SSH, SMTP, ICMP).
5. Убедиться, что правило расположено **выше** разрешающих правил в списке (правила применяются сверху вниз).
6. Включить правило и сохранить.

### 4. Что такое NAT и для чего он используется?

**Ответ:**  
NAT (Network Address Translation) — это метод трансляции (преобразования) сетевых адресов, который позволяет изменять IP-адреса в заголовках пакетов при их прохождении через маршрутизатор или межсетевой экран.

**Основные задачи NAT:**
- **Экономия публичных IP-адресов**: позволяет множеству устройств локальной сети с приватными адресами (например, 192.168.x.x) выходить в интернет через один публичный IP-адрес.
- **Скрытие внутренней структуры сети**: внешние узлы не видят реальные адреса устройств внутри локальной сети.
- **Обеспечение безопасности**: NAT создает дополнительный уровень изоляции между внутренней и внешней сетью.

**Типы NAT в UserGate:**
- **SNAT (Source NAT)** — изменение адреса источника (используется для выхода клиентов в интернет).
- **DNAT (Destination NAT)** — изменение адреса назначения (используется для публикации внутренних серверов).
- **Port Forwarding** — проброс портов (частный случай DNAT с изменением порта).

### 5. Что такое инспектирование SSL и зачем оно нужно?

**Ответ:**  
Инспектирование SSL (SSL Inspection) — это технология, позволяющая межсетевому экрану расшифровывать зашифрованный SSL/TLS трафик для его анализа и применения политик безопасности (фильтрация контента, антивирусная проверка, обнаружение вторжений).

**Принцип работы:**
1. UserGate перехватывает запрос клиента на установление SSL-соединения с удаленным сервером.
2. Устанавливает SSL-соединение с сервером от своего имени.
3. Расшифровывает полученные данные от сервера.
4. Анализирует содержимое трафика (проверяет на вирусы, применяет фильтры контента).
5. Генерирует новый сертификат для клиента, подписанный внутренним центром сертификации UserGate.
6. Устанавливает SSL-соединение с клиентом, передавая ему расшифрованные данные.

По сути, UserGate выполняет атаку типа Man-in-the-Middle (MITM), но в легитимных целях защиты.

**Для корректной работы** необходимо установить корневой сертификат UserGate CA в хранилище доверенных сертификатов на всех клиентских устройствах, чтобы браузеры не выдавали предупреждения о недоверенном сертификате.

### 6. Что такое пропускная способность и как ее ограничить в UserGate?

**Ответ:**  
Пропускная способность (Bandwidth) — это максимальная скорость передачи данных по сетевому каналу, измеряемая в битах в секунду (бит/с, Кбит/с, Мбит/с).

**Ограничение пропускной способности в UserGate** позволяет:
- Обеспечить справедливое распределение канала между пользователями.
- Предотвратить перегрузку канала отдельными пользователями или приложениями.
- Гарантировать минимальную скорость для критически важных приложений.
- Приоритизировать трафик (например, отдавать приоритет VoIP перед торрентами).

**Настройка ограничения:**
1. Переходим в **Политики сети** → **Пропускная способность**.
2. Создаем новое правило.
3. Указываем источник трафика (пользователи, группы, IP-адреса, зоны).
4. Создаем или выбираем профиль полосы пропускания с указанием:
   - **Гарантированная скорость** (минимальная скорость, которая будет предоставлена)
   - **Максимальная скорость** (ограничение максимальной скорости)
5. Опционально настраиваем метки DSCP для QoS.
6. Сохраняем и активируем правило.

### 7. В каком порядке применяются правила в UserGate?

**Ответ:**  
Правила в UserGate применяются **последовательно сверху вниз** в том порядке, в котором они указаны в списке. Выполняется **только первое правило**, для которого совпали все указанные в нём условия.

**Важные принципы:**
- Более **специфичные правила** должны располагаться **выше** общих правил.
- **Запрещающие правила** для конкретных протоколов/адресов должны быть выше общих разрешающих правил.
- В конце списка межсетевого экрана всегда находится правило **"Блокировать все"** (Default block), которое нельзя удалить, переместить или отключить.
- Для корректной работы политик безопасности необходимо тщательно продумывать порядок правил.

**Пример правильного порядка:**
1. Блокировка опасных ботнетов (высокий приоритет)
2. Блокировка определенных протоколов/портов
3. Разрешение конкретных сервисов для конкретных пользователей
4. Общее разрешающее правило
5. "Блокировать все" (Default block)

---

## Выводы

В ходе лабораторной работы были выполнены следующие задачи:

1. **Установлен и настроен UserGate NGFW** в среде виртуализации VMWare Workstation с двумя сетевыми адаптерами: Internal Network для зоны Management и Bridge для зоны Trusted с выходом в интернет.

2. **Выполнена первоначальная настройка** системы через консоль и веб-интерфейс, включая:
   - Назначение статических IP-адресов интерфейсам.
   - Настройку DNS-серверов и шлюза по умолчанию.
   - Проверку доступности интернета для UserGate NGFW.

3. **Подключена клиентская машина** под управлением Windows 10/11 к внутренней сети UserGate с настройкой статического IP-адреса и сетевых параметров.

4. **Настроены правила NAT и межсетевого экрана**:
   - Создано базовое правило NAT для трансляции адресов из зоны Management в зону Trusted.
   - Созданы разрешающие и запрещающие правила межсетевого экрана в правильной последовательности.
   - Проверена работоспособность доступа клиента в интернет.

5. **Выполнено управление пропускной способностью**:
   - Проведен замер скорости интернет-соединения на клиенте до ограничения.
   - Настроено правило ограничения пропускной способности до 10 Мбит/с.
   - Проведен повторный замер, подтвердивший работу ограничения.
   - Результаты сравнены и задокументированы.

6. **Настроена фильтрация трафика по протоколам**:
   - Создано правило разрешения HTTP/HTTPS подключений.
   - Создано правило блокировки ICMP-запросов.
   - Продемонстрирована работа правил: веб-сайты открываются, ping не проходит.

7. **Выполнено задание на автомат — настройка фильтрации контента с инспектированием SSL**:
   - Включено инспектирование SSL для трафика из зоны Management.
   - Экспортирован сертификат удостоверяющего центра UserGate CA.
   - Сертификат импортирован в хранилище доверенных корневых сертификатов на клиентской машине Windows.
   - Создано правило фильтрации контента для блокировки поисковика Яндекс.
   - Продемонстрирована успешная блокировка доступа к yandex.ru при сохранении доступа к другим поисковым системам.

8. **Изучены журналы и мониторинг** системы для отслеживания событий безопасности и активных соединений.

9. **Получены практические навыки** работы с межсетевыми экранами нового поколения (NGFW), понимание концепций зон безопасности, правил NAT, управления трафиком и фильтрации контента.

10. **Подготовлены ответы на контрольные вопросы** о зонах безопасности, протоколах, NAT, инспектировании SSL и принципах работы UserGate NGFW.

Работа считается выполненной полностью, все цели достигнуты, включая задание на автомат.

---

## Список использованных источников

1. Методические указания по лабораторной работе №6 «UserGate NGFW».
2. Официальная документация UserGate NGFW 7.x — [https://docs.usergate.com/](https://docs.usergate.com/)
3. UserGate :: Портал документации — Настройка зон — [https://docs.usergate.com/nastrojka-zon_780.html](https://docs.usergate.com/nastrojka-zon_780.html)
4. UserGate :: Портал документации — NAT и маршрутизация — [https://docs.usergate.com/nat-i-marshrutizaciya_1072.html](https://docs.usergate.com/nat-i-marshrutizaciya_1072.html)
5. UserGate :: Портал документации — Межсетевой экран — [https://docs.usergate.com/mezhsetevoj-ekran_857.html](https://docs.usergate.com/mezhsetevoj-ekran_857.html)
6. UserGate :: Портал документации — Пропускная способность — [https://docs.usergate.com/propusknaya-sposobnost6_125.html](https://docs.usergate.com/propusknaya-sposobnost6_125.html)
7. UserGate :: Портал документации — Инспектирование SSL — [https://docs.usergate.com/inspektirovanie-ssl_1075.html](https://docs.usergate.com/inspektirovanie-ssl_1075.html)
8. UserGate :: Портал документации — Фильтрация контента — [https://docs.usergate.com/fil6traciya-kontenta_714.html](https://docs.usergate.com/fil6traciya-kontenta_714.html)
9. UserGate :: Портал документации — Управление сертификатами — [https://docs.usergate.com/upravlenie-sertifikatami_864.html](https://docs.usergate.com/upravlenie-sertifikatami_864.html)
10. Хабр — UserGate Getting Started. Политики безопасности — [https://habr.com/ru/companies/tssolution/articles/527706/](https://habr.com/ru/companies/tssolution/articles/527706/)